#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define BMP_HEADER__STARTING_ADDRESS 10
#define DIB_HEADER__PIXEL_WIDTH 18
#define DIB_HEADER__PIXEL_HEIGHT 22
#define DIB_HEADER__BP_PIXEL 28

#define SCALE 1e5

int32_t sine_table[360] = {
    0,       1745,   3489,   5233,   6975,   8715,   10452,  12186,  13917,
    15643,   17364,  19080,  20791,  22495,  24192,  25881,  27563,  29237,
    30901,   32556,  34202,  35836,  37460,  39073,  40673,  42261,  43837,
    45399,   46947,  48480,  49999,  51503,  52991,  54463,  55919,  57357,
    58778,   60181,  61566,  62932,  64278,  65605,  66913,  68199,  69465,
    70710,   71933,  73135,  74314,  75470,  76604,  77714,  78801,  79863,
    80901,   81915,  82903,  83867,  84804,  85716,  86602,  87461,  88294,
    89100,   89879,  90630,  91354,  92050,  92718,  93358,  93969,  94551,
    95105,   95630,  96126,  96592,  97029,  97437,  97814,  98162,  98480,
    98768,   99026,  99254,  99452,  99619,  99756,  99862,  99939,  99984,
    100000,  99984,  99939,  99862,  99756,  99619,  99452,  99254,  99026,
    98768,   98480,  98162,  97814,  97437,  97029,  96592,  96126,  95630,
    95105,   94551,  93969,  93358,  92718,  92050,  91354,  90630,  89879,
    89100,   88294,  87461,  86602,  85716,  84804,  83867,  82903,  81915,
    80901,   79863,  78801,  77714,  76604,  75470,  74314,  73135,  71933,
    70710,   69465,  68199,  66913,  65605,  64278,  62932,  61566,  60181,
    58778,   57357,  55919,  54463,  52991,  51503,  49999,  48480,  46947,
    45399,   43837,  42261,  40673,  39073,  37460,  35836,  34202,  32556,
    30901,   29237,  27563,  25881,  24192,  22495,  20791,  19080,  17364,
    15643,   13917,  12186,  10452,  8715,   6975,   5233,   3489,   1745,
    0,       -1745,  -3489,  -5233,  -6975,  -8715,  -10452, -12186, -13917,
    -15643,  -17364, -19080, -20791, -22495, -24192, -25881, -27563, -29237,
    -30901,  -32556, -34202, -35836, -37460, -39073, -40673, -42261, -43837,
    -45399,  -46947, -48480, -50000, -51503, -52991, -54463, -55919, -57357,
    -58778,  -60181, -61566, -62932, -64278, -65605, -66913, -68199, -69465,
    -70710,  -71933, -73135, -74314, -75470, -76604, -77714, -78801, -79863,
    -80901,  -81915, -82903, -83867, -84804, -85716, -86602, -87461, -88294,
    -89100,  -89879, -90630, -91354, -92050, -92718, -93358, -93969, -94551,
    -95105,  -95630, -96126, -96592, -97029, -97437, -97814, -98162, -98480,
    -98768,  -99026, -99254, -99452, -99619, -99756, -99862, -99939, -99984,
    -100000, -99984, -99939, -99862, -99756, -99619, -99452, -99254, -99026,
    -98768,  -98480, -98162, -97814, -97437, -97029, -96592, -96126, -95630,
    -95105,  -94551, -93969, -93358, -92718, -92050, -91354, -90630, -89879,
    -89100,  -88294, -87461, -86602, -85716, -84804, -83867, -82903, -81915,
    -80901,  -79863, -78801, -77714, -76604, -75470, -74314, -73135, -71933,
    -70710,  -69465, -68199, -66913, -65605, -64278, -62932, -61566, -60181,
    -58778,  -57357, -55919, -54463, -52991, -51503, -50000, -48480, -46947,
    -45399,  -43837, -42261, -40673, -39073, -37460, -35836, -34202, -32556,
    -30901,  -29237, -27563, -25881, -24192, -22495, -20791, -19080, -17364,
    -15643,  -13917, -12186, -10452, -8715,  -6975,  -5233,  -3489,  -1745};

int32_t cosine_table[360] = {
    100000,  99984,  99939,  99862,  99756,  99619,  99452,  99254,  99026,
    98768,   98480,  98162,  97814,  97437,  97029,  96592,  96126,  95630,
    95105,   94551,  93969,  93358,  92718,  92050,  91354,  90630,  89879,
    89100,   88294,  87461,  86602,  85716,  84804,  83867,  82903,  81915,
    80901,   79863,  78801,  77714,  76604,  75470,  74314,  73135,  71933,
    70710,   69465,  68199,  66913,  65605,  64278,  62932,  61566,  60181,
    58778,   57357,  55919,  54463,  52991,  51503,  50000,  48480,  46947,
    45399,   43837,  42261,  40673,  39073,  37460,  35836,  34202,  32556,
    30901,   29237,  27563,  25881,  24192,  22495,  20791,  19080,  17364,
    15643,   13917,  12186,  10452,  8715,   6975,   5233,   3489,   1745,
    0,       -1745,  -3489,  -5233,  -6975,  -8715,  -10452, -12186, -13917,
    -15643,  -17364, -19080, -20791, -22495, -24192, -25881, -27563, -29237,
    -30901,  -32556, -34202, -35836, -37460, -39073, -40673, -42261, -43837,
    -45399,  -46947, -48480, -49999, -51503, -52991, -54463, -55919, -57357,
    -58778,  -60181, -61566, -62932, -64278, -65605, -66913, -68199, -69465,
    -70710,  -71933, -73135, -74314, -75470, -76604, -77714, -78801, -79863,
    -80901,  -81915, -82903, -83867, -84804, -85716, -86602, -87461, -88294,
    -89100,  -89879, -90630, -91354, -92050, -92718, -93358, -93969, -94551,
    -95105,  -95630, -96126, -96592, -97029, -97437, -97814, -98162, -98480,
    -98768,  -99026, -99254, -99452, -99619, -99756, -99862, -99939, -99984,
    -100000, -99984, -99939, -99862, -99756, -99619, -99452, -99254, -99026,
    -98768,  -98480, -98162, -97814, -97437, -97029, -96592, -96126, -95630,
    -95105,  -94551, -93969, -93358, -92718, -92050, -91354, -90630, -89879,
    -89100,  -88294, -87461, -86602, -85716, -84804, -83867, -82903, -81915,
    -80901,  -79863, -78801, -77714, -76604, -75470, -74314, -73135, -71933,
    -70710,  -69465, -68199, -66913, -65605, -64278, -62932, -61566, -60181,
    -58778,  -57357, -55919, -54463, -52991, -51503, -50000, -48480, -46947,
    -45399,  -43837, -42261, -40673, -39073, -37460, -35836, -34202, -32556,
    -30901,  -29237, -27563, -25881, -24192, -22495, -20791, -19080, -17364,
    -15643,  -13917, -12186, -10452, -8715,  -6975,  -5233,  -3489,  -1745,
    0,       1745,   3489,   5233,   6975,   8715,   10452,  12186,  13917,
    15643,   17364,  19080,  20791,  22495,  24192,  25881,  27563,  29237,
    30901,   32556,  34202,  35836,  37460,  39073,  40673,  42261,  43837,
    45399,   46947,  48480,  50000,  51503,  52991,  54463,  55919,  57357,
    58778,   60181,  61566,  62932,  64278,  65605,  66913,  68199,  69465,
    70710,   71933,  73135,  74314,  75470,  76604,  77714,  78801,  79863,
    80901,   81915,  82903,  83867,  84804,  85716,  86602,  87461,  88294,
    89100,   89879,  90630,  91354,  92050,  92718,  93358,  93969,  94551,
    95105,   95630,  96126,  96592,  97029,  97437,  97814,  98162,  98480,
    98768,   99026,  99254,  99452,  99619,  99756,  99862,  99939,  99984};

void rotate(int16_t x1, int16_t y1, int16_t deg, int16_t *x2, int16_t *y2) {
  int32_t cos_theta = cosine_table[deg % 360];
  int32_t sin_theta = sine_table[deg % 360];

  *x2 = (x1 * cos_theta - y1 * sin_theta) / SCALE;
  *y2 = (x1 * sin_theta + y1 * cos_theta) / SCALE;
}

int main(int argc, char **argv) {
  const char *infname = argv[1];
  const char *outfname = argv[2];
  const int16_t deg = atol(argv[3]);

  FILE *infile = fopen(infname, "rb");
  FILE *outfile = fopen(outfname, "wb");

  // read header data
  uint8_t bmp_header[54];
  fread(bmp_header, 1, 54, infile); // Read the BMP header

  int32_t width = *(int32_t *)&bmp_header[DIB_HEADER__PIXEL_WIDTH];
  int32_t height = *(int32_t *)&bmp_header[DIB_HEADER__PIXEL_HEIGHT];
  uint16_t bits_per_pixel = *(uint16_t *)&bmp_header[DIB_HEADER__BP_PIXEL];
  uint32_t offset = *(uint32_t *)&bmp_header[BMP_HEADER__STARTING_ADDRESS];

  // calculate sizes
  uint8_t bytes_per_pixel = bits_per_pixel / 8;
  size_t pixel_array_size = width * height * bytes_per_pixel;
  size_t write_size = offset + pixel_array_size;

  // allocate buffers
  uint8_t *read_buffer = (uint8_t *)malloc(pixel_array_size);
  uint8_t *write_buffer = (uint8_t *)calloc(pixel_array_size, sizeof(uint8_t));

  // read pixel data
  fseek(infile, offset, SEEK_SET);
  fread(read_buffer, 1, pixel_array_size, infile);

  // rotate pixel array and store in write buffer
  int16_t row_t, col_t;
  for (int16_t row = 0; row < height; row++) {
    for (int16_t col = 0; col < width; col++) {
      int32_t src_index = (row * width + col) * bytes_per_pixel;
      rotate(row - height / 2, col - width / 2, deg, &row_t, &col_t);
      row_t += height / 2;
      col_t += width / 2;

      if (row_t >= 0 && row_t < height && col_t >= 0 && col_t < width) {
        int32_t dest_index = (row_t * width + col_t) * bytes_per_pixel;
        memcpy(write_buffer + dest_index, read_buffer + src_index,
               bytes_per_pixel);
      }
    }
  }

  // write headers and rotated pixel array to output file
  fwrite(bmp_header, 1, 54, outfile); // Write BMP header
  fseek(outfile, offset, SEEK_SET);
  fwrite(write_buffer, 1, pixel_array_size, outfile);

  // Clean up
  free(read_buffer);
  free(write_buffer);
  fclose(infile);
  fclose(outfile);

  return 0;
}
